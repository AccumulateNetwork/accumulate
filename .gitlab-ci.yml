stages:
  - test
  - build
  - deploy
  - validate

variables:
  BOLD_RED: '\e[1;31m'
  NO_COLOR: '\e[0m'
  SECTION: '\e[0K'
  PRODUCTION_IMAGE: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}
  VALIDATION_IMAGE: ${CI_REGISTRY_IMAGE}/validation:${CI_COMMIT_REF_SLUG}

merge request target:
  needs: []
  rules:
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  script:
  # Merge requests can only be merged into develop
  # See https://gitlab.com/gitlab-org/gitlab/-/merge_requests/52532
  - echo "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
  - test "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" == "$CI_DEFAULT_BRANCH"

.go:
  image: golang:1.17
  cache:
    key: go-mod-cache
    paths:
      - .go-mod-cache
  variables:
    GOMODCACHE: ${CI_PROJECT_DIR}/.go-mod-cache
  before_script:
  - |
    function build-daemon {
      export GOOS=$1
      export GOARCH=$2
      BIN=accumulated
      [ -z "$GOOS" ] || BIN=${BIN}-${GOOS}
      [ -z "$GOARCH" ] || BIN=${BIN}-${GOARCH}
      [[ $GOOS == windows ]] && BIN=${BIN}.exe
      export BUILDFLAGS="-o ${BIN}"
      echo -e "${SECTION}section_start:`date +%s`:build_${GOOS}_${GOARCH}\r${SECTION}Build accumulated for $GOOS $GOARCH"
      make GIT_COMMIT=${CI_COMMIT_SHA} GIT_DESCRIBE=${GIT_DESCRIBE}
      echo -e "${SECTION}section_end:`date +%s`:build_${GOOS}_${GOARCH}\r${SECTION}";
    }

test:
  stage: test
  extends: .go
  needs: []
  rules:
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  - if: $CI_PIPELINE_SOURCE == 'push'
  artifacts:
    when: always
    reports:
      junit: report.xml
  script:
  - go build -v ./...
  - go run gotest.tools/gotestsum --junitfile report.xml --format testname

git describe:
  stage: build
  needs: []
  rules:
  - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  - if: $CI_PIPELINE_SOURCE == 'push'
  script:
  - git fetch --unshallow
  - echo "GIT_DESCRIBE=$(git describe --dirty)" >> git.env
  artifacts:
    reports:
      dotenv: git.env

docker buildx:
  image: docker:20-git
  stage: build
  needs: []
  only:
  - develop
  - tags
  variables:
    GIT_STRATEGY: none
  artifacts:
    paths:
      - buildx
    expire_in: 1 day
  services: [ docker:20-dind ]
  script:
    - export DOCKER_BUILDKIT=1
    - git clone https://github.com/docker/buildx ./docker-buildx
    - docker build --platform=local -o . ./docker-buildx

build images:
  stage: build
  image: docker:20
  services: [ docker:20-dind ]
  needs: []
  script:
    - docker build -t ${VALIDATION_IMAGE} .
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push ${VALIDATION_IMAGE}

build multiarch images:
  stage: build
  needs: [ docker buildx ]
  image: docker:20
  only:
  - develop
  - tags
  services:
    - name: docker:20-dind
      command: [ --experimental ] # Do we need this?
  before_script:
    - mkdir -p ~/.docker/cli-plugins
    - mv buildx ~/.docker/cli-plugins/docker-buildx
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
  script:
    - docker buildx create --use
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker buildx build --platform linux/amd64,linux/arm64 --push -t ${PRODUCTION_IMAGE} .

lint:
  stage: build
  extends: .go
  needs: [ ]
  before_script:
    - function die { echo -e "${BOLD_RED}${1}${NO_COLOR}"; false; }
  script:
    - echo -e "${SECTION}section_start:`date +%s`:vet\r${SECTION}Vet"
    - go vet ./...
    - echo -e "${SECTION}section_end:`date +%s`:vet\r${SECTION}"

    - echo -e "${SECTION}section_start:`date +%s`:lint\r${SECTION}Lint"
    - go run github.com/golangci/golangci-lint/cmd/golangci-lint run --verbose --timeout=10m ./...
    - echo -e "${SECTION}section_end:`date +%s`:lint\r${SECTION}"

    - echo -e "${SECTION}section_start:`date +%s`:tidy\r${SECTION}Verify go.mod is tidy"
    - go mod tidy
    - git diff --quiet go.mod go.sum || die "Go mod files are not tidy. Please run \`go mod tidy\`."
    - echo -e "${SECTION}section_end:`date +%s`:tidy\r${SECTION}"

    - echo -e "${SECTION}section_start:`date +%s`:generate\r${SECTION}Verify generated files are up to date"
    - go generate -x ./...
    - git diff --quiet || die "Generated files are not up to date. Please run \`go generate ./...\`."
    - echo -e "${SECTION}section_end:`date +%s`:generate\r${SECTION}"

    - echo -e "${SECTION}section_start:`date +%s`:imports\r${SECTION}Verify code is correctly formatted"
    - go run github.com/rinchsan/gosimports/cmd/gosimports -l */ | tee fmt.log
    - test -s fmt.log && die "Code is incorrectly formatted. Please run \`gosimports -w .\` (or \`./scripts/imports.sh\`)."
    - echo -e "${SECTION}section_end:`date +%s`:imports\r${SECTION}"

build binaries:
  stage: build
  extends: .go
  needs: [ git describe ]
  only:
  - develop
  - tags
  script:
    - build-daemon linux amd64
    - build-daemon linux arm64
    - build-daemon windows amd64
    - build-daemon windows arm64
    - build-daemon darwin amd64
    - build-daemon darwin arm64
  artifacts:
    paths:
      - accumulated-*

build manual binaries:
  stage: build
  extends: .go
  needs: [ git describe ]
  when: manual
  except:
  - develop
  - tags
  script:
    - build-daemon linux amd64
    - build-daemon linux arm64
    - build-daemon windows amd64
    - build-daemon windows arm64
    - build-daemon darwin amd64
    - build-daemon darwin arm64
  artifacts:
    paths:
      - accumulated-*

configure:
  stage: build
  extends: .go
  needs: [ git describe ]
  only: [ develop ]
  script:
  - |
    function init {
      ./accumulated init -w config-$1 "${@:2}" -n $1
      (cd config-$1 && tar czf ../config-$1.tar.gz *)
    }
  - build-daemon
  - build-daemon linux arm64
  - init DevNet.Directory --no-empty-blocks --no-website
  - init DevNet.Zion --no-empty-blocks
  - init DevNet.Yellowstone --no-empty-blocks
  artifacts:
    paths:
    - config-*.tar.gz
    - accumulated-*

.deploy:
  stage: deploy
  only: [ develop ] # only run on the main branch
  needs: [ configure, test ]
  tags:
  - linux
  - docker
  - accumulate
  image: ubuntu
  script:
  - apt-get -y update && apt-get -y install ssh
  - mkdir ~/.ssh
  - cp ${SSH_KNOWN_HOSTS} ~/.ssh/known_hosts
  - cp ${SSH_PRIV_KEY} ~/.ssh/id_rsa
  - cp ${SSH_PUB_KEY} ~/.ssh/id_rsa.pub
  - chmod -R 600 ~/.ssh
  - ./scripts/ci/devnet-deploy.sh

deploy 1/4:
  extends: .deploy
  variables:   { HOST: 172.31.4.106,  NETWORK: Zion,         NODE: 0, DN_NODE: 0, BIN: accumulated-linux-arm64 }
  environment: { url: 'http://172.31.4.106:8080',  name: Zion/0 }

deploy 2/4:
  extends: .deploy
  variables:   { HOST: 172.31.11.185, NETWORK: Zion,         NODE: 1, DN_NODE: 1, BIN: accumulated-linux-arm64 }
  environment: { url: 'http://172.31.11.185:8080', name: Zion/1 }

deploy 3/4:
  extends: .deploy
  variables:   { HOST: 172.31.11.104, NETWORK: Yellowstone,  NODE: 0, DN_NODE: 2, BIN: accumulated-linux-arm64 }
  environment: { url: 'http://172.31.11.104:8080', name: Yellowstone/0 }

deploy 4/4:
  extends: .deploy
  variables:   { HOST: 172.31.13.8,   NETWORK: Yellowstone,  NODE: 1, DN_NODE: 3, BIN: accumulated-linux-arm64 }
  environment: { url: 'http://172.31.13.8:8080',   name: Yellowstone/1 }

.validate:
  stage: validate
  extends: .go
  only: [ develop ] # only run on the main branch
  needs: [ deploy 1/4, deploy 2/4, deploy 3/4, deploy 4/4 ]
  variables:
    ACC_API: https://devnet.accumulatenetwork.io/v2
    # set mnemonic for predictable addresses
    MNEMONIC: yellow yellow yellow yellow yellow yellow yellow yellow yellow yellow yellow yellow

validate docker:
  stage: validate
  needs: [ build images ]
  image: docker
  services: [ docker:dind ]
  allow_failure: true
  variables:
    # set mnemonic for predictable addresses
    MNEMONIC: yellow yellow yellow yellow yellow yellow yellow yellow yellow yellow yellow yellow
    NODE_ROOT: /nodes/dn/Node0
  script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  - docker run --rm -v ${PWD}/nodes:/nodes ${VALIDATION_IMAGE} init devnet -w /nodes --docker --image ${VALIDATION_IMAGE} --compose -b 3 -v 3
  - cd nodes
  - apk add --no-cache docker-compose
  - docker-compose up -d
  - docker-compose run -e MNEMONIC="${MNEMONIC}" -e NODE_ROOT="${NODE_ROOT}" --rm --entrypoint bash tools /scripts/ci/validate.sh
  - docker-compose down

validate devnet:
  stage: validate
  extends: .go
  needs: []
  variables:
    MNEMONIC: yellow yellow yellow yellow yellow yellow yellow yellow yellow yellow yellow yellow
  script:
  - apt-get -y update && apt-get -y install jq xxd
  - go run ./tools/test/devnet/ -v 1 -b 1 --reset

validate:
  extends: .validate
  allow_failure: true
  script:
  - apt-get -y update && apt-get -y install jq xxd
  - ./scripts/ci/validate.sh

.validate matrix 1/6:
   extends: .validate
   script:
   - ./scripts/matrix/test_case_1.1.sh

.validate matrix 2/6:
   extends: .validate
   script:
   - ./scripts/matrix/test_case_2.1.sh
   - ./scripts/matrix/test_case_2.2.sh
   - ./scripts/matrix/test_case_2.3.sh
   - ./scripts/matrix/test_case_2.4.sh
   - ./scripts/matrix/test_case_2.5.sh
   - ./scripts/matrix/test_case_2.6.sh
   - ./scripts/matrix/test_case_2.7.sh

.validate matrix 3/6:
   extends: .validate
   script:
   - ./scripts/matrix/test_case_3.1.sh
   - ./scripts/matrix/test_case_3.2.sh
   - ./scripts/matrix/test_case_3.3.sh
   - ./scripts/matrix/test_case_3.4.sh

.validate matrix 4/6:
   extends: .validate
   script:
   - ./scripts/matrix/test_case_4.1.sh
   - ./scripts/matrix/test_case_4.2.sh
   - ./scripts/matrix/test_case_4.3.sh
   - ./scripts/matrix/test_case_4.4.sh
   - ./scripts/matrix/test_case_4.5.sh
   - ./scripts/matrix/test_case_4.6.sh
   - ./scripts/matrix/test_case_4.7.sh
   - ./scripts/matrix/test_case_4.8.sh

.validate matrix 5/6:
   extends: .validate
   script:
   - ./scripts/matrix/test_case_5.1.sh
   - ./scripts/matrix/test_case_5.2.sh

.validate matrix 6/6:
   extends: .validate
   script:
   - ./scripts/matrix/test_case_6.1.sh
   - ./scripts/matrix/test_case_6.2.sh
   - ./scripts/matrix/test_case_6.3.sh
   - ./scripts/matrix/test_case_6.4.sh
   - ./scripts/matrix/test_case_6.5.sh
   - ./scripts/matrix/test_case_6.6.sh
   - ./scripts/matrix/test_case_6.7.sh

.cleanup images:
  # Once validation is done, delete the images
  # Disabled because it doesn't appear to work, though it was copied from GitLab's docs
  stage: validate
  image: docker:20
  services: [ docker:20-dind ]
  needs: [ validate docker ]
  variables:
    REG_SHA256: ade837fc5224acd8c34732bf54a94f579b47851cc6a7fd5899a98386b782e228
    REG_VERSION: 0.16.1
  before_script:
  - apk add --no-cache curl
  - curl --fail --show-error --location "https://github.com/genuinetools/reg/releases/download/v$REG_VERSION/reg-linux-amd64" --output /usr/local/bin/reg
  - echo "$REG_SHA256  /usr/local/bin/reg" | sha256sum -c -
  - chmod a+x /usr/local/bin/reg
  script:
  - /usr/local/bin/reg rm -d --auth-url $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD ${VALIDATION_IMAGE}